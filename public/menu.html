<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ÙˆÛŒ Ú©Ø§ÙÙ‡ Ø§Ø³Ú©Ø§ÛŒ Ù…ÙˆÙ†</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-Digits/font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    colors: {
                        brand: {
                            green: 'var(--brand-btn-color, #00b862)', // Ø±Ù†Ú¯ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¯Ú©Ù…Ù‡
                            cream: 'var(--brand-bg-color, #f9f5f0)', // Ø±Ù†Ú¯ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ú©Ø§Ø±Øª
                            text: 'var(--brand-text-color, #333)',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø±Ù†Ú¯ÛŒ Ù¾Ø§ÛŒÙ‡ */
        :root { --primary-color: #d4af37; --page-bg: #ffffff; --brand-text-color: #333; }
        
        body { background-color: var(--page-bg); color: var(--brand-text-color); transition: background 0.5s; }
        
        /* Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ø§Ø± Ø§ÙÙ‚ÛŒ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù„ÙˆØ¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ */
        .animate-up { animation: slideUp 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªÙ… Ùˆ Ø¯Ú©ÙˆØ±Ø§Ø³ÛŒÙˆÙ† */
        .falling-item { position: fixed; top: -30px; z-index: 9998; pointer-events: none; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(105vh) rotate(360deg); } }
        
        .corner-decoration {
            position: fixed; bottom: 0; z-index: 9999; pointer-events: none;
            transition: all 0.5s ease-in-out; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }
        .corner-left { left: 0; width: 180px; transform-origin: bottom left; }
        .corner-right { right: 0; width: 160px; transform-origin: bottom right; }
        .sway { animation: sway 3s infinite ease-in-out alternate; }
        .bounce-slow { animation: bounceSlow 4s infinite ease-in-out; }
        
        @keyframes sway { from { transform: rotate(-2deg); } to { transform: rotate(2deg); } }
        @keyframes bounceSlow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        @media (max-width: 768px) {
            .corner-decoration { width: 100px !important; }
        }
    </style>
</head>
<body class="font-sans leading-relaxed pb-20">

    <header class="flex justify-between items-center p-5 sticky top-0 bg-white/95 backdrop-blur-sm z-50 shadow-sm transition-colors" id="main-header">
        <button class="text-2xl opacity-70"><i class="fas fa-bars"></i></button>
        <div class="text-center">
            <span class="text-xl font-black tracking-wide" id="logo-text" style="color: #4a00e0;">SKYMOON</span>
            <span class="block text-[10px] opacity-50 -mt-1 tracking-widest uppercase">Cafe & Restaurant</span>
        </div>
        <a href="index.html" class="text-xl opacity-70"><i class="fas fa-arrow-left"></i></a>
    </header>

    <section class="mt-4 px-4">
        <h2 class="text-lg font-bold mb-4 opacity-90">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h2>
        <div id="category-container" class="flex overflow-x-auto gap-3 pb-4 scrollbar-hide snap-x"></div>
    </section>

    <main class="mt-2 px-4 container mx-auto max-w-2xl">
        <div id="menu-grid" class="flex flex-col gap-6"></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const categoryContainer = document.getElementById('category-container');
            const menuGrid = document.getElementById('menu-grid');
            let allItems = [];

            // 1. Ø¯Ø±ÛŒØ§ÙØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÙ… Ø§Ø² Ø³Ø±ÙˆØ±
            try {
                const res = await fetch('/api/theme');
                if (res.ok) {
                    const theme = await res.json();
                    applyTheme(theme);
                }
            } catch(e) { console.log('Theme loading error'); }

            // 2. Ø¯Ø±ÛŒØ§ÙØª Ù…Ù†Ùˆ Ø§Ø² Ø³Ø±ÙˆØ±
            try {
                const res = await fetch('/api/menu');
                if(!res.ok) throw new Error();
                allItems = await res.json();
                if(allItems.length > 0) { 
                    renderCategories(allItems); 
                    renderItems('Ù‡Ù…Ù‡'); 
                } else {
                    menuGrid.innerHTML = '<p class="text-center opacity-50 mt-10">Ù…Ù†Ùˆ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>';
                }
            } catch(e) { 
                menuGrid.innerHTML = '<p class="text-center text-red-500 mt-10">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…Ù†Ùˆ</p>'; 
            }

            // --- ØªÙˆØ§Ø¨Ø¹ Ø±Ù†Ø¯Ø±ÛŒÙ†Ú¯ ---

            function renderCategories(items) {
                const categories = ['Ù‡Ù…Ù‡', ...new Set(items.map(i => i.category))];
                categoryContainer.innerHTML = '';
                categories.forEach((cat, index) => {
                    let imgUrl = 'https://via.placeholder.com/150';
                    if(cat==='Ù‡Ù…Ù‡' && items[0]?.image) imgUrl = items[0].image;
                    else { const f = items.find(i=>i.category===cat); if(f?.image) imgUrl = f.image; }

                    const btn = document.createElement('div');
                    btn.className = `min-w-[140px] h-[90px] rounded-2xl relative overflow-hidden cursor-pointer snap-center shadow-md group border border-white/20 transition-all duration-300`;
                    btn.innerHTML = `
                        <img src="${imgUrl}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/50 group-hover:bg-black/40 transition-colors"></div>
                        <div class="absolute inset-0 flex flex-col justify-center items-center text-white z-10">
                            <span class="font-bold text-lg shadow-black drop-shadow-md text-center px-1">${cat}</span>
                        </div>`;
                    
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('#category-container > div').forEach(d => d.classList.remove('ring-4', 'ring-brand-green'));
                        btn.classList.add('ring-4', 'ring-brand-green');
                        renderItems(cat);
                    });
                    
                    if(index===0) btn.classList.add('ring-4', 'ring-brand-green');
                    categoryContainer.appendChild(btn);
                });
            }

            function renderItems(filter) {
                menuGrid.innerHTML = '';
                // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§ÙˆÙ„ÙˆÛŒØª
                let filtered = filter === 'Ù‡Ù…Ù‡' ? allItems : allItems.filter(i => i.category === filter);
                filtered.sort((a, b) => (a.priority || 0) - (b.priority || 0));

                if(filtered.length === 0) { menuGrid.innerHTML = '<p class="text-center opacity-50 py-10">Ø§ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>'; return; }

                filtered.forEach((item, index) => {
                    const price = Number(item.price).toLocaleString();
                    const img = item.image || 'https://via.placeholder.com/400';
                    const delay = index * 50;
                    
                    menuGrid.innerHTML += `
                        <div class="bg-brand-cream rounded-[30px] overflow-hidden shadow-lg animate-up flex flex-col group relative border border-white/50" style="animation-delay: ${delay}ms">
                            
                            ${item.is_featured ? `<div class="absolute top-4 right-4 bg-white/95 text-black px-3 py-1 rounded-full text-xs font-bold shadow-md z-10 backdrop-blur-sm"><i class="fas fa-star text-yellow-500 mr-1"></i>ÙˆÛŒÚ˜Ù‡</div>` : ''}
                            
                            <div class="w-full aspect-square relative overflow-hidden">
                                <img src="${img}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" alt="${item.name}">
                                <div class="absolute bottom-0 left-0 right-0 h-24 bg-gradient-to-t from-black/10 to-transparent"></div>
                            </div>

                            <div class="p-5 flex flex-col flex-grow text-brand-text relative">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-xl font-black">${item.name}</h3>
                                </div>
                                
                                <p class="opacity-70 text-sm mb-4 line-clamp-2 leading-6">${item.description || ''}</p>
                                
                                <div class="mt-auto flex justify-between items-center pt-4 border-t border-black/5">
                                    <button class="bg-brand-green text-white px-6 py-2.5 rounded-xl font-bold hover:opacity-90 transition shadow-lg active:scale-95 text-sm">Ø³ÙØ§Ø±Ø´</button>
                                    <div class="flex flex-col items-end">
                                        <span class="font-black text-xl dir-ltr text-brand-green">${price}</span>
                                        <span class="opacity-50 text-[10px]">ØªÙˆÙ…Ø§Ù†</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });
            }

            // --- ØªÙˆØ§Ø¨Ø¹ ØªÙ… Ùˆ Ø¯Ú©ÙˆØ±Ø§Ø³ÛŒÙˆÙ† ---

            function applyTheme(theme) {
                const root = document.documentElement;
                const occ = theme.occasion || 'none';

                if(theme.menuBg && theme.menuBg.trim() !== '') {
                    document.body.style.backgroundImage = `url('${theme.menuBg}')`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundAttachment = 'fixed';
                }

                document.querySelectorAll('.corner-decoration').forEach(el => el.remove());

                if (occ === 'christmas') {
                    setThemeColors('#d42f2f', '#fff0f0', '#333');
                    createFallingEffect('â„ï¸');
                    addDecorations('https://cdn-icons-png.flaticon.com/512/744/744546.png', 'https://cdn-icons-png.flaticon.com/512/3794/3794356.png');
                } 
                else if (occ === 'yalda') {
                    setThemeColors('#b91c1c', '#2a0a0a', '#ffffff');
                    root.style.setProperty('--page-bg', '#1a0505');
                    const header = document.getElementById('main-header');
                    header.classList.remove('bg-white/95');
                    header.classList.add('bg-black/80', 'text-white');
                    createFallingEffect('ğŸ‰');
                    addDecorations('https://cdn-icons-png.flaticon.com/512/4062/4062916.png', 'https://cdn-icons-png.flaticon.com/512/2224/2224256.png');
                } 
                else if (occ === 'valentine') {
                    setThemeColors('#db2777', '#fce7f3', '#333');
                    document.getElementById('logo-text').style.color = '#db2777';
                    createFallingEffect('â¤ï¸');
                    addDecorations('https://cdn-icons-png.flaticon.com/512/2826/2826720.png', 'https://cdn-icons-png.flaticon.com/512/833/833472.png');
                } 
                else if (occ === 'nowruz') {
                    setThemeColors('#10b981', '#ecfdf5', '#333');
                    createFallingEffect('ğŸŒ¸');
                    addDecorations('https://cdn-icons-png.flaticon.com/512/3075/3075932.png', 'https://cdn-icons-png.flaticon.com/512/10609/10609536.png');
                }
            }

            function setThemeColors(btn, bg, text) {
                const root = document.documentElement;
                root.style.setProperty('--brand-btn-color', btn);
                root.style.setProperty('--brand-bg-color', bg);
                root.style.setProperty('--brand-text-color', text);
            }

            function addDecorations(leftImg, rightImg) {
                if(leftImg) {
                    const img = document.createElement('img'); img.src = leftImg; img.className = 'corner-decoration corner-left sway';
                    document.body.appendChild(img);
                }
                if(rightImg) {
                    const img = document.createElement('img'); img.src = rightImg; img.className = 'corner-decoration corner-right bounce-slow';
                    document.body.appendChild(img);
                }
            }

            function createFallingEffect(emoji) {
                if(document.querySelector('.falling-item')) return;
                setInterval(() => {
                    const el = document.createElement('div');
                    el.className = 'falling-item';
                    el.innerText = emoji;
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.fontSize = (Math.random() * 20 + 10) + 'px';
                    el.style.animationDuration = (Math.random() * 3 + 4) + 's'; 
                    el.style.opacity = Math.random();
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 7000);
                }, 400);
            }
        });
    </script>
</body>
</html>

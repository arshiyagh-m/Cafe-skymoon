<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ÙˆÛŒ Ú©Ø§ÙÙ‡ Ø§Ø³Ú©Ø§ÛŒ Ù…ÙˆÙ†</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/misc/Farsi-Digits/font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Vazirmatn', 'sans-serif'] },
                    colors: {
                        brand: {
                            green: 'var(--brand-btn-color, #00b862)', // Ø±Ù†Ú¯ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ø¯Ú©Ù…Ù‡
                            cream: 'var(--brand-bg-color, #f9f5f0)', // Ø±Ù†Ú¯ Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ© Ú©Ø§Ø±Øª
                            text: 'var(--brand-text-color, #333)',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: var(--page-bg, #ffffff); color: var(--brand-text-color, #333); transition: background 0.5s; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-up { animation: slideUp 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        
        /* Ø§ÙÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨ØªÛŒ */
        .snowflake, .heart, .flower { position: fixed; top: -20px; z-index: 9999; pointer-events: none; animation-name: fall; animation-timing-function: linear; animation-iteration-count: infinite; }
        @keyframes fall { to { transform: translateY(105vh); } }
    </style>
</head>
<body class="font-sans leading-relaxed pb-20">

    <header class="flex justify-between items-center p-5 sticky top-0 bg-white/95 backdrop-blur-sm z-50 shadow-sm transition-colors" id="main-header">
        <button class="text-2xl opacity-70"><i class="fas fa-bars"></i></button>
        <div class="text-center">
            <span class="text-xl font-black tracking-wide" id="logo-text" style="color: #4a00e0;">SKYMOON</span>
            <span class="block text-[10px] opacity-50 -mt-1 tracking-widest uppercase">Cafe & Restaurant</span>
        </div>
        <a href="index.html" class="text-xl opacity-70"><i class="fas fa-arrow-left"></i></a>
    </header>

    <section class="mt-4 px-4">
        <h2 class="text-lg font-bold mb-4 opacity-90">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h2>
        <div id="category-container" class="flex overflow-x-auto gap-3 pb-4 scrollbar-hide snap-x"></div>
    </section>

    <main class="mt-2 px-4 container mx-auto max-w-2xl">
        <div id="menu-grid" class="flex flex-col gap-6"></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const categoryContainer = document.getElementById('category-container');
            const menuGrid = document.getElementById('menu-grid');
            let allItems = [];

            // Û±. Ø¯Ø±ÛŒØ§ÙØª ØªÙ… Ùˆ Ø§Ø¹Ù…Ø§Ù„ Ø¸Ø§Ù‡Ø±
            try {
                const theme = await (await fetch('/api/theme')).json();
                applyTheme(theme);
            } catch(e) {}

            // Û². Ø¯Ø±ÛŒØ§ÙØª Ù…Ù†Ùˆ
            try {
                const res = await fetch('/api/menu');
                if(!res.ok) throw new Error();
                allItems = await res.json();
                if(allItems.length > 0) { renderCategories(allItems); renderItems('Ù‡Ù…Ù‡'); }
                else menuGrid.innerHTML = '<p class="text-center opacity-50 mt-10">Ù…Ù†Ùˆ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>';
            } catch(e) { menuGrid.innerHTML = '<p class="text-center text-red-500 mt-10">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª</p>'; }

            // ØªØ§Ø¨Ø¹ Ø§Ø¹Ù…Ø§Ù„ ØªÙ…
            function applyTheme(theme) {
                const root = document.documentElement;
                const occ = theme.occasion || 'none';

                // ØªØµÙˆÛŒØ± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ù…Ù†Ùˆ (Ø§Ú¯Ø± ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)
                if(theme.menuBg) {
                    document.body.style.backgroundImage = `url('${theme.menuBg}')`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundAttachment = 'fixed';
                }

                // Ù…Ù†Ø·Ù‚ Ù…Ù†Ø§Ø³Ø¨Øªâ€ŒÙ‡Ø§
                if (occ === 'christmas') {
                    root.style.setProperty('--brand-btn-color', '#d42f2f'); // Ù‚Ø±Ù…Ø² Ú©Ø±ÛŒØ³Ù…Ø³
                    root.style.setProperty('--brand-bg-color', '#fff0f0'); // Ø²Ù…ÛŒÙ†Ù‡ ØµÙˆØ±ØªÛŒ Ø®ÛŒÙ„ÛŒ Ú©Ù…â€ŒØ±Ù†Ú¯
                    createFallingEffect('â„ï¸');
                } else if (occ === 'yalda') {
                    root.style.setProperty('--brand-btn-color', '#b91c1c'); // Ù‚Ø±Ù…Ø² Ø§Ù†Ø§Ø±ÛŒ
                    root.style.setProperty('--brand-bg-color', '#2a0a0a'); // Ø²Ù…ÛŒÙ†Ù‡ ØªÛŒØ±Ù‡ ÛŒÙ„Ø¯Ø§
                    root.style.setProperty('--brand-text-color', '#ffffff'); // Ù…ØªÙ† Ø³ÙÛŒØ¯
                    root.style.setProperty('--page-bg', '#1a0505'); 
                    document.getElementById('main-header').classList.remove('bg-white/95');
                    document.getElementById('main-header').classList.add('bg-black/80', 'text-white');
                    createFallingEffect('ğŸ‰');
                } else if (occ === 'valentine') {
                    root.style.setProperty('--brand-btn-color', '#db2777'); // ØµÙˆØ±ØªÛŒ Ø¬ÛŒØº
                    root.style.setProperty('--brand-bg-color', '#fce7f3'); // Ø²Ù…ÛŒÙ†Ù‡ ØµÙˆØ±ØªÛŒ Ø±ÙˆØ´Ù†
                    document.getElementById('logo-text').style.color = '#db2777';
                    createFallingEffect('â¤ï¸');
                } else if (occ === 'nowruz') {
                    root.style.setProperty('--brand-btn-color', '#10b981'); // Ø³Ø¨Ø² Ø¨Ù‡Ø§Ø±ÛŒ
                    root.style.setProperty('--brand-bg-color', '#ecfdf5'); // Ø³Ø¨Ø² Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù†
                    createFallingEffect('ğŸŒ¸');
                }
            }

            function renderCategories(items) {
                const categories = ['Ù‡Ù…Ù‡', ...new Set(items.map(i => i.category))];
                categoryContainer.innerHTML = '';
                categories.forEach((cat, index) => {
                    let imgUrl = 'https://via.placeholder.com/150';
                    if(cat==='Ù‡Ù…Ù‡' && items[0]?.image) imgUrl = items[0].image;
                    else { const f = items.find(i=>i.category===cat); if(f?.image) imgUrl = f.image; }

                    const btn = document.createElement('div');
                    btn.className = `min-w-[140px] h-[90px] rounded-2xl relative overflow-hidden cursor-pointer snap-center shadow-md group border border-white/20`;
                    btn.innerHTML = `<img src="${imgUrl}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"><div class="absolute inset-0 bg-black/50 group-hover:bg-black/40 transition-colors"></div><div class="absolute inset-0 flex flex-col justify-center items-center text-white z-10"><span class="font-bold text-lg shadow-black drop-shadow-md text-center px-1">${cat}</span></div>`;
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('#category-container > div').forEach(d => d.classList.remove('ring-4', 'ring-white'));
                        btn.classList.add('ring-4', 'ring-white');
                        renderItems(cat);
                    });
                    if(index===0) btn.classList.add('ring-4', 'ring-white');
                    categoryContainer.appendChild(btn);
                });
            }

            function renderItems(filter) {
                menuGrid.innerHTML = '';
                const filtered = filter === 'Ù‡Ù…Ù‡' ? allItems : allItems.filter(i => i.category === filter);
                if(filtered.length === 0) { menuGrid.innerHTML = '<p class="text-center opacity-50 py-10">Ø®Ø§Ù„ÛŒ</p>'; return; }

                filtered.forEach((item, index) => {
                    const price = Number(item.price).toLocaleString();
                    const img = item.image || 'https://via.placeholder.com/300';
                    const delay = index * 100;
                    const badge = item.is_featured ? `<div class="absolute top-4 right-4 bg-white/90 text-black px-3 py-1 rounded-full text-xs font-bold shadow-sm z-10">ÙˆÛŒÚ˜Ù‡</div>` : '';

                    menuGrid.innerHTML += `
                        <div class="bg-brand-cream rounded-[35px] p-6 relative shadow-soft animate-up flex flex-col items-center text-center group text-brand-text" style="animation-delay: ${delay}ms">
                            ${badge}
                            <div class="w-48 h-48 mb-4 relative drop-shadow-xl transition-transform duration-500 group-hover:scale-105"><img src="${img}" class="w-full h-full object-contain" alt="${item.name}"></div>
                            <h3 class="text-2xl font-black mb-2">${item.name}</h3>
                            ${item.description ? `<p class="opacity-70 text-sm mb-6 line-clamp-2 px-2">${item.description}</p>` : '<div class="mb-4"></div>'}
                            <div class="w-full flex justify-between items-center mt-auto px-2 border-t border-black/5 pt-4">
                                <button class="bg-brand-green text-white px-6 py-2.5 rounded-xl font-bold hover:opacity-90 transition shadow-lg active:scale-95 text-sm">Ø³ÙØ§Ø±Ø´</button>
                                <div class="flex flex-col items-end"><span class="font-black text-xl dir-ltr text-brand-green">${price}</span><span class="opacity-50 text-[10px]">ØªÙˆÙ…Ø§Ù†</span></div>
                            </div>
                        </div>`;
                });
            }

            function createFallingEffect(emoji) {
                setInterval(() => {
                    const el = document.createElement('div');
                    el.innerText = emoji;
                    el.style.cssText = `position:fixed; top:-30px; left:${Math.random()*100}vw; font-size:${Math.random()*20+10}px; animation:fall ${Math.random()*3+3}s linear; z-index:9999; opacity:${Math.random()}; pointer-events:none;`;
                    document.body.appendChild(el);
                    setTimeout(()=>el.remove(), 6000);
                }, 300);
                const style = document.createElement('style');
                style.innerHTML = `@keyframes fall { to { transform: translateY(105vh) rotate(${Math.random()*360}deg); } }`;
                document.head.appendChild(style);
            }
        });
    </script>
</body>
</html>
